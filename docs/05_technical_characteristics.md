# Технические характеристики торгового алгоритма

## Режим торговли и рынок

- Режим: **Cross Margin** (Binance).
- Инструмент: `BTCUSDT` (зашито в `BinanceMarginExecution`).
- Тип стратегии: **Directional Hedge Scalping**.
- Хедж-вход: одновременный BUY и SELL с одинаковым `qty`.

## Состояния конечного автомата

- `IDLE` → ожидание.
- `ARMED` → готов к запуску цикла.
- `ENTERING` → вход и открытие хеджа.
- `DETECTING` → поиск победителя.
- `CUTTING` → закрытие проигравшей ноги.
- `RIDING` → сопровождение победителя.
- `EXITING` → выход победителя.
- `COOLDOWN` → пауза перед следующим циклом.
- `ERROR` → ошибка и остановка цикла.

## Источники данных и выбор effective tick

- Источники:
  - **WebSocket** тики (`ws_market`).
  - **HTTP fallback** (`http_fallback`).
- Режимы:
  - `WS_ONLY` → используется только WS,
  - `HTTP_ONLY` → используется только HTTP,
  - `HYBRID` → автоматическое переключение.

Поведение в `HYBRID`:

- При «свежем» WS (моложе `ws_fresh_ms`) — WS становится источником.
- При падении WS — используется HTTP, удерживается `http_hold_ms`.
- Возврат на WS требует streak `ws_recovery_ticks` подряд свежих тиков.

## Ордерная логика

- Типы ордеров:
  - `market` — немедленное исполнение.
  - `aggressive_limit` — IOC лимит с проскальзыванием `slip_bps`.
- Вход:
  - SELL с `AUTO_BORROW_REPAY`.
  - BUY без side effect.
- Закрытие ног:
  - Для шорта — `AUTO_REPAY`.
  - Для лонга — обычный SELL.
- Тайминги:
  - `aggressive_limit` ждёт 0.4s, затем fallback на market.
  - `market` ждёт подтверждения до 3s.

## Параметры стратегии (ключевые)

- `usd_notional` — номинал входа в USD.
- `max_spread_bps` — лимит спреда.
- `min_tick_rate` — минимальная скорость тиков.
- `impulse_min_bps` — минимальный импульс.
- `winner_threshold_bps` — порог определения победителя.
- `target_net_bps` — целевая прибыль победителя после комиссий.
- `emergency_stop_bps` — порог экстренного стопа.
- `max_loss_bps` — базовый стоп-лосс.
- `detect_timeout_ms` — таймаут ожидания победителя.
- `detect_window_ticks` — количество тиков до сравнения победителя.
- `cooldown_s` — длительность cooldown между циклами.
- `order_mode` — `market` или `aggressive_limit`.
- `slip_bps` — проскальзывание для aggressive limit.

## Контроль риска и безопасности

- Запрет на вход при открытой экспозиции или незакрытых ордерах.
- Проверка минимального лота/ноционала по фильтрам биржи.
- Проверка equity для соблюдения `leverage_max`.
- Аварийное выравнивание позиции при любых критических ошибках.
- Принудительный выход при устаревании данных (> 1500 мс).

## Производительность и надёжность

- `TradeEngine` работает в отдельном потоке для UI.
- Watchdog проверяет «фриз» GUI по heartbeat каждые 2 секунды.
- Логи выводятся в UI и пишутся в файл (rotating).

## Журналы и мониторинг

- **TRADE** — ключевые события цикла (вход, победитель, выход).
- **STATE** — переходы состояний и метрики цикла.
- **DEALS** — подтверждения исполнения и сводка сделки.
- **INFO/ERROR** — сервисная и аварийная диагностика.
