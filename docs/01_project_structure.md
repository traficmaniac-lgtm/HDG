# Структура проекта

Документ описывает актуальную структуру репозитория Directional Hedge Scalper,
уровни вложенности и связи между подсистемами.

## Верхний уровень

- `README.md` — краткое описание, установка, запуск и заметки по циклам.
- `requirements.txt` — зависимости Python.
- `RUN_GUI.ps1` — сценарий запуска GUI (Windows).
- `.env.example` — шаблон переменных окружения (API ключи и режимы).
- `.gitignore`, `.gitkeep` — настройки Git и поддержка пустых директорий.
- `docs/` — документация по архитектуре, алгоритмам и характеристикам.
- `src/` — исходный код приложения.
- `tests/` — минимальные проверки алгоритмов и сервисов.

### Директории, создаваемые во время работы

- `config/` — локальные настройки и параметры стратегии (`settings.json`,
  `strategy_params.json`).
- `logs/` — файлы логов приложения (`bot.log` с ротацией).

## Директория `docs/`

- `01_project_structure.md` — структура репозитория и связи подсистем.
- `02_file_responsibilities.md` — назначение файлов.
- `03_calculation_algorithms.md` — формулы и вычисления метрик/фильтров.
- `04_trading_algorithm_cycle.md` — детальный торговый цикл и состояния.
- `05_technical_characteristics.md` — технические параметры, режимы и риски.
- `06_configuration_and_operations.md` — конфигурация, UI, рабочие потоки.

## Директория `src/`

### `src/app/`

- Точка входа GUI и инициализация приложения.
- Привязка UI ↔ `TradeEngine` ↔ потоков данных.

### `src/core/`

- Конфигурация и модели данных (параметры стратегии, снимки рынка, телеметрия цикла).
- Логирование и ротация (`logger.py`).
- Конечный автомат состояний (`BotStateMachine`).
- `TradeEngine` — оркестратор жизненного цикла, автоцикла и соединений.

### `src/engine/`

- Реализация торгового цикла: вход → детект победителя → отсечение → ride → выход.
- Аварийные сценарии (controlled/emergency flatten).
- Тестовый режим и эмуляции.

### `src/exchange/`

- Исполнение ордеров на Binance Cross Margin.
- Методы выставления, отмены, ожидания заполнения, repay.

### `src/services/`

- Рыночные данные:
  - WebSocket (`ws_market.py`) — bookTicker + depth.
  - HTTP fallback (`http_fallback.py`) — bookTicker REST.
- Агрегация и переключение источников (`market_data.py`).
- REST клиент Binance (`binance_rest.py`) и синхронизация времени (`time_sync.py`).
- Подсистема стакана (`orderbook.py`).

### `src/gui/`

- Пользовательский интерфейс (Qt/PySide6).
- Вкладки настроек и параметров стратегии, журналы, таблицы сделок и статуса.
- Общие UI-компоненты и вспомогательные виджеты.

## Директория `tests/`

- Проверки тикрейта/импульса, окна детекта и маржинальных sideEffectType.

## Поток данных (высокий уровень)

1. GUI инициализирует `TradeEngine`, параметры и режимы.
2. `MarketDataThread` получает WS данные и публикует тики.
3. `MarketDataService` агрегирует WS/HTTP тики и выбирает «effective tick».
4. `DirectionalCycle` применяет фильтры входа и управляет ордерами/состояниями.
5. `BinanceMarginExecution` исполняет ордера через REST.

## Ключевые точки интеграции

- **GUI → TradeEngine**: запуск/остановка, параметры стратегии, режимы данных.
- **TradeEngine → DirectionalCycle**: контроль цикла, обновление фильтров и логика автоцикла.
- **DirectionalCycle → Exchange**: размещение ордеров, отмены, ожидание fill, repay.
- **MarketDataService → DirectionalCycle**: снапшоты тиков, метрики, возраст данных.
