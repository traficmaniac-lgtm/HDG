# Конфигурация и эксплуатация

Документ описывает источники конфигурации, структуру UI и основные сценарии
использования.

## Конфигурационные источники

### Переменные окружения

Используются при наличии `.env.local` (приоритет ниже `config/settings.json`):

- `BINANCE_API_KEY`
- `BINANCE_API_SECRET`
- `BINANCE_MODE` (например, `MARGIN`)
- `BINANCE_LEVERAGE` (целевое плечо 1–3)
- `BINANCE_LIVE_ENABLED` (true/false)

Шаблон находится в `.env.example`.

### Локальные файлы конфигурации

- `config/settings.json` — настройки подключения:
  `api_key`, `api_secret`, `mode`, `leverage`, `save_local`, `live_enabled`.
- `config/strategy_params.json` — параметры стратегии (по умолчанию и по символам).

### Логи

- `logs/bot.log` — основной лог с ротацией (до 5 файлов по 5MB).

## Графический интерфейс (GUI)

### Вкладка «Настройки»

- Поля API ключа/секрета.
- Режим (Cross Margin).
- Плечо (1x–3x, для контроля borrow).
- Переключатели:
  - «Сохранять локально» → запись в `config/settings.json`.
  - «Реальная торговля включена» → позволяет отправлять реальные ордера.
- Действия:
  - **Сохранить** — записывает настройки.
  - **Проверить связь** — запросы `spot`/`margin` аккаунтов.
  - **Очистить** — сброс локальных значений.

### Вкладка «Параметры»

Ключевые поля стратегии (соответствуют `StrategyParams`):

- Номинал USD, max leverage, max loss, target net.
- Импульс-фильтр (min + grace) и порог победителя.
- Таймауты детекта и окно детекта.
- Режим ордера (`market`/`aggressive_limit`) и `slip_bps`.
- Auto-loop и `max_cycles`.

### Основные элементы рабочего окна

- Кнопки управления циклом (старт/стоп/flatten).
- Метрики (tick rate, spread, impulse, ws/http age).
- Таблица сделок и журнал событий.
- Статус соединения, режима данных и состояния FSM.

## Рабочие таймеры и частоты

- HTTP fallback: каждые **1000 ms**.
- Обновление баланса: каждые **10 000 ms**.
- Heartbeat UI → watchdog: каждые **500 ms**.
- Run-loop проверки автоцикла: каждые **150 ms**.

## Сценарии использования

1. Запустить приложение (`RUN_GUI.ps1` или `python -m src.app.main`).
2. Ввести API ключи, сохранить настройки и проверить связь.
3. Выбрать символ, загрузить exchange info (лот/тик фильтры).
4. Настроить параметры стратегии и режим данных (`WS_ONLY` / `HTTP_ONLY` / `HYBRID`).
5. Нажать «Старт» для перехода в `DETECT`.
6. При необходимости остановить цикл или вызвать flatten.

## Безопасность

- Реальные ордера не отправляются без включённого `live_enabled`.
- При ошибках авторизации (`-1002`) цикл прекращается и вход блокируется.

## DataFeed hysteresis rules

Для режима `HYBRID` источник данных выбирается с гистерезисом: WS имеет приоритет, но при деградации WS система переключается на HTTP и держит его минимум `http_hold_ms`. Возврат на WS возможен только после серии подряд свежих тиков (`ws_recovery_ticks`) и выдержки минимального времени подключения (`ws_min_connected_ms`) с учётом `switch_cooldown_ms`. 

Свежесть определяется по возрасту тиков (`ws_fresh_ms` и `http_fresh_ms`), а не по форсированному tick rate. Логи переключений источника пишутся один раз на событие и содержат причину и возраст тиков, чтобы было видно, когда источник действительно восстановился. 
