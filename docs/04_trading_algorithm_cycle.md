# Алгоритм торговли: полный цикл

Документ описывает фактический цикл в `DirectionalCycle` и связанные состояния
`BotStateMachine`.

## 0. Общая идея

Алгоритм открывает **две противоположные позиции одновременно** (BUY + SELL) на одном
инструменте. Далее он:

1. Ждёт движение цены и определяет «победителя».
2. Закрывает проигравшую ногу.
3. Сопровождает победителя до цели/стопа.
4. Закрывает победителя и фиксирует результат.

Цикл контролирует актуальность данных, корректность фильтров, маржинальную
экспозицию и исполнение ордеров.

## 1. Подготовка (ARMED)

- Бот переводится в состояние `ARMED`.
- Фиксируется снимок данных (bid/ask/mid, возраст тиков, WS статус).
- Запоминается время `armed_ts` для логики импульсного grace.

## 2. Попытка входа (ENTERING)

Вход допускается только если:

- Есть хотя бы один тик (WS/HTTP) и данные не `stale`.
- Загружены фильтры символа (`step_size`, `min_qty`, `min_notional`).
- Нет открытой экспозиции.
- Выполнены фильтры входа (spread/tick_rate/impulse/leverage).

### 2.1. Расчёт количества

1. `qty = usd_notional / mid`.
2. Округление вниз по `step_size`.
3. Проверки `min_qty` и `min_notional`.

### 2.2. Отправка ордеров

- Используются **последние WS bid/ask** для расчёта цены.
- Отправляется два ордера:
  - **SELL** (короткая нога) с `AUTO_BORROW_REPAY`.
  - **BUY** (длинная нога).
- Режим ордера:
  - `market` — немедленное исполнение.
  - `aggressive_limit` — лимит c проскальзыванием `slip_bps`.

### 2.3. Контроль заполнения

- Ожидание fill:
  - `market` — до 3s.
  - `aggressive_limit` — до 0.4s с отменой и fallback на `market`.
- Если один из ордеров не исполнен — **аварийное выравнивание**.

После успешного входа состояние меняется на `DETECTING`.

## 3. Поиск победителя (DETECTING)

- Окно детекта: `detect_window_ticks` (min 5).
- Таймаут: `detect_timeout_ms` (не меньше минимально допустимого по tick rate).
- Победитель определяется по изменению `mid` относительно `entry_mid`.
- При достижении `winner_threshold_bps` определяется сторона (LONG/SHORT).

Если победитель не найден до таймаута, применяется политика **no-winner**.

## 4. No-winner политика (DETECT_TIMEOUT)

Параметры:

- `allow_no_winner_flatten` — разрешить контролируемый выход.
- `no_winner_policy`:
  - `NO_LOSS` → попытка закрыть обе ноги IOC (`aggressive_limit`), либо рынок.
  - `FLATTEN` → controlled flatten (маркет-выравнивание).

Если ни одна стратегия не разрешена — цикл завершится без flatten.

## 5. Отсечение проигравшего (CUTTING)

- Закрывается проигравшая нога (market или aggressive_limit).
- Для шорта используется `AUTO_REPAY`.
- При ошибке — аварийное выравнивание.

## 6. Сопровождение победителя (RIDING)

Постоянно пересчитывается:

- `winner_raw_bps` относительно `entry_mid`.
- `winner_net_bps = winner_raw_bps - fee_total_bps`.

Выход при любом условии:

1. `winner_net_bps >= target_net_bps` → цель.
2. `winner_raw_bps <= -emergency_stop_bps` → экстренный стоп.
3. `winner_raw_bps <= -max_loss_bps` → стоп-лосс.
4. `effective_age_ms > 1500` → устаревшие данные.

## 7. Выход победителя (EXITING)

- Победитель закрывается market/aggressive_limit.
- Для шорта используется `AUTO_REPAY`.
- Фиксируются цены входа/выхода, bps и итоговые метрики.

## 8. COOLDOWN и автоцикл

- После завершения цикл переходит в `COOLDOWN` на `cooldown_s`.
- Если включён `auto_loop`, происходит возврат в `ARMED` и запуск нового цикла.
- `max_cycles` ограничивает число циклов в авто-режиме.

## 9. Controlled / Emergency flatten

- **CONTROLLED_FLATTEN** — управляемый выход (используется при no-winner).
- **EMERGENCY_FLATTEN** — аварийное выравнивание при частичном входе,
  ошибке исполнения или таймауте.

### Аварийный сценарий

1. Отмена открытых ордеров.
2. Закрытие экспозиции market-ордерами.
3. Repay заёмных средств.
4. Логирование причины.

## 10. Основные причины завершения цикла

- `target` — достигнута цель.
- `emergency_stop` — экстренный стоп.
- `stop_loss` — обычный стоп-лосс.
- `data_stale` — устаревшие данные.
- `detect_timeout` — победитель не найден.
- `cut_loser_failed` / `exit_winner_failed` — ошибки исполнения.
- `enter_exception` — исключение на входе.
- `no_winner_*` — завершение по no-winner политике.
