# Алгоритм торговли: полный цикл

Документ описывает фактический цикл в `DirectionalCycle` и состояния
`BotStateMachine`.

## 0. Общая идея

Алгоритм открывает **две противоположные позиции одновременно** (BUY + SELL) на одном
инструменте. Далее он:

1. Ждёт движение цены и определяет «победителя».
2. Закрывает проигравшую ногу.
3. Сопровождает победителя до цели/стопа.
4. Закрывает победителя и фиксирует результат.

Цикл контролирует актуальность данных, корректность фильтров, маржинальную
экспозицию и исполнение ордеров.

## 1. Состояния конечного автомата

Фактические состояния (`BotState`):

- `IDLE` → ожидание.
- `DETECT` → «armed» режим: ожидание входа, сбор данных для детекта.
- `ENTERED_LONG` → заполнена длинная нога (вход частично выполнен).
- `ENTERED_SHORT` → заполнена короткая нога (вход частично выполнен).
- `WAIT_WINNER` → ожидание победителя / сопровождение победителя.
- `EXIT` → закрытие победителя.
- `FLATTEN` → управляемое/аварийное выравнивание.
- `COOLDOWN` → пауза между циклами.
- `ERROR` → ошибка.

## 2. Подготовка и armed

- При нажатии «Старт» или авто-цикле вызывается `arm()`.
- Состояние переводится в `DETECT`, фиксируется снимок данных.
- Запоминается `armed_ts` для логики импульсного grace.

## 3. Попытка входа (`attempt_entry`)

Вход допускается только если:

- Есть хотя бы один тик (WS/HTTP) и данные не `stale`.
- Загружены фильтры символа (`step_size`, `min_qty`, `min_notional`).
- Нет открытой экспозиции и активных ордеров.
- Выполнены фильтры входа (spread/tick_rate/impulse/leverage/anti-noise).

### 3.1. Расчёт количества

1. `qty = usd_notional / mid`.
2. Округление вниз по `step_size`.
3. Проверки `min_qty` и `min_notional`.

### 3.2. Отправка ордеров

- Используются **последние WS bid/ask** для расчёта цены.
- Отправляется два ордера:
  - **SELL** (короткая нога) с `AUTO_BORROW_REPAY`.
  - **BUY** (длинная нога).
- Режим ордера:
  - `market` — немедленное исполнение.
  - `aggressive_limit` — лимит c проскальзыванием `slip_bps`.

### 3.3. Контроль заполнения

- Ожидание fill:
  - `market` — до `wait_fill_timeout_ms`.
  - `aggressive_limit` — ожидание `0.4s`, затем cancel и fallback на `market`.
- Частичное заполнение фиксируется состояниями `ENTERED_LONG`/`ENTERED_SHORT`.
- Если одна из ног не исполнена — запускается выравнивание.

После успешного входа состояние меняется на `WAIT_WINNER`.

## 4. Поиск победителя (`WAIT_WINNER`)

- Окно детекта: `detect_window_ticks` (min 5).
- Таймаут: `detect_timeout_ms`.
- Победитель определяется по изменению `mid` относительно `entry_mid`.
- При достижении `winner_threshold_bps` определяется сторона (LONG/SHORT).

Если победитель не найден до таймаута, применяется `force_flatten`.

## 5. Отсечение проигравшего (cut)

- Закрывается проигравшая нога (market или aggressive_limit).
- Для шорта используется `AUTO_REPAY`.
- При ошибке — аварийное выравнивание.

После отсечения цикл остаётся в `WAIT_WINNER`, но переходит в фазу ride.

## 6. Сопровождение победителя (`WAIT_WINNER`)

Постоянно пересчитывается:

- `winner_raw_bps` относительно `entry_mid`.
- `winner_net_bps = winner_raw_bps - fee_total_bps`.

Выход при любом условии:

1. `winner_net_bps >= target_net_bps` → цель.
2. `winner_raw_bps <= -emergency_stop_bps` → экстренный стоп.
3. `winner_raw_bps <= -max_loss_bps` → стоп-лосс.
4. `effective_age_ms > data_stale_exit_ms` → устаревшие данные.
5. `max_ride_ms` → лимит длительности ride.

## 7. Выход победителя (`EXIT`)

- Победитель закрывается market/aggressive_limit.
- Для шорта используется `AUTO_REPAY`.
- Фиксируются цены входа/выхода, bps и итоговые метрики.

## 8. COOLDOWN и автоцикл

- После завершения цикл переходит в `COOLDOWN` на `cooldown_s`.
- Если включён `auto_loop`, происходит возврат в `DETECT` и запуск нового цикла.
- `max_cycles` ограничивает число циклов в авто-режиме.

## 9. Controlled / Emergency flatten

- **CONTROLLED** — управляемый выход (попытка закрыть позиции с логикой IOC/market).
- **EMERGENCY** — аварийное выравнивание при частичном входе,
  ошибке исполнения или таймауте.

### Аварийный сценарий

1. Отмена открытых ордеров.
2. Закрытие экспозиции market-ордерами.
3. Repay заёмных средств.
4. Логирование причины.

## 10. Основные причины завершения цикла

- `OK` — успешный выход победителя.
- `TIMEOUT` — сработал таймаут (детект/ride/exit).
- `NO_EDGE` — анти-шум/отсутствие преимущества.
- `LOSS` — стоп/убыток.
- `ERROR` — ошибки исполнения или авторизации.
