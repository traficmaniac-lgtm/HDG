# Алгоритм торговли: полный цикл

Ниже описан полный цикл directional hedge scalping, реализованный в `DirectionalCycle`.
Документ описывает как бизнес-логику, так и фактические проверки/тайминги,
привязанные к состояниям конечного автомата.

## 0. Общая идея

Алгоритм открывает **две противоположные позиции одновременно** (BUY и SELL) на одном
и том же инструменте. Далее он:

1. Наблюдает краткосрочное движение цены.
2. Определяет «победителя» (сторону, куда пошло движение).
3. Закрывает проигравшую ногу.
4. Сопровождает победителя до цели/стопа/проблем с данными.

На каждом этапе жёстко контролируются:

- доступность рыночных данных;
- корректность фильтров символа;
- наличие открытой экспозиции;
- успешность исполнения ордеров и тайм-ауты.

## 1. Подготовка (ARMED)

Перед стартом цикла бот переводится в состояние **ARMED**. На этом этапе:

- проверяется наличие тиков (WS/HTTP);
- подтягиваются фильтры символа (`step_size`, `min_qty`, `min_notional`, `tick_size`);
- формируется «снимок» состояния данных (возраст тиков, источник, признак stale);
- проверяется отсутствие открытой экспозиции (нет активных ордеров и нет задолженностей
  по BTC/USDT).

Если данные недоступны или фильтры не загружены, вход не инициируется.

## 2. Попытка входа (ENTERING)

Вход инициируется вручную или автолупом, но допускается только если выполнены
все фильтры:

- есть актуальный тик (WS/HTTP);
- загружены фильтры инструмента;
- нет открытой экспозиции и открытых ордеров;
- `data_stale = False` (текущий источник данных не `NONE`);
- `spread_bps <= max_spread_bps`;
- `tick_rate >= min_tick_rate`;
- `impulse_bps >= impulse_min_bps`;
- проверка leverage: суммарная экспозиция двух ног не превышает лимит по equity.

### 2.1. Расчёт объёма

1. `qty = usd_notional / mid`.
2. Округление вниз по `step_size`.
3. Проверка `min_qty` и `min_notional`.

### 2.2. Отправка ордеров

Отправляется два ордера:

- **SELL** (короткая нога) с `AUTO_BORROW_REPAY`.
- **BUY** (длинная нога).

Режим ордера:

- `market` — немедленное исполнение.
- `aggressive_limit` — IOC-лимит с ценой **на 1 тик «хуже»** текущего bid/ask
  и fallback на market при тайм-ауте 0.4s.

### 2.3. Контроль заполнения

- Оба ордера должны быть заполнены.
- Если частично заполнено — срабатывает **аварийное выравнивание**.
- При исключении/ошибке исполнения — `EMERGENCY_FLATTEN`.

После успешного входа цикл переходит в **DETECTING**.

## 3. Поиск победителя (DETECTING)

Параметры обнаружения:

- окно тиков: `detect_window_ticks`;
- таймаут: `detect_timeout_ms`.

Победитель определяется по движению mid от `entry_mid`:

- `LONG raw bps = (mid_now - entry_mid) / entry_mid * 10_000`;
- `SHORT raw bps = (entry_mid - mid_now) / entry_mid * 10_000`.

Если **оба движения ниже `winner_threshold_bps`**, победитель не фиксируется.
При превышении порога фиксируется сторона с большим bps.

После выявления победителя цикл переходит в **CUTTING**.

## 4. Отсечение проигравшего (CUTTING)

- Проигравшая нога закрывается рыночным или aggressive-limit ордером.
- Для шорта используется `AUTO_REPAY`.
- При ошибке или тайм-ауте — аварийное выравнивание.

После закрытия проигравшего цикл переходит в **RIDING**.

## 5. Сопровождение победителя (RIDING)

Алгоритм постоянно пересчитывает:

- `winner_raw_bps` относительно `entry_mid`;
- `winner_net_bps = winner_raw_bps - fee_total_bps`.

Условия выхода из RIDING:

1. **Target**: `winner_net_bps >= target_net_bps`.
2. **Emergency stop**: `winner_raw_bps <= -emergency_stop_bps`.
3. **Stop loss**: `winner_raw_bps <= -max_loss_bps`.
4. **Stale data**: `effective_age_ms > 1500`.

Обновления состояния логируются раз в ~0.5s.

## 6. Выход победителя (EXITING)

- Победитель закрывается рыночным или aggressive-limit ордером.
- Для шорта используется `AUTO_REPAY`.
- Фиксируются цены, bps, итоговые метрики сделки.

После выхода:

- выполняется `repay` по BTC/USDT (если есть задолженность);
- состояние меняется на **COOLDOWN**.

## 7. Охлаждение (COOLDOWN)

- Фиксированная пауза `cooldown_s`.
- При авто-режиме цикл возвращается в **ARMED**.
- Вручную можно остановить или завершить cooldown.

## 8. Аварийное выравнивание (EMERGENCY FLATTEN)

Срабатывает если:

- частичный вход;
- ошибка при закрытии ноги;
- тайм-аут ожидания ордеров;
- ручной вызов.

Действия:

1. Отмена открытых ордеров.
2. Закрытие свободного BTC/шорт-позиции market-ордерами.
3. Погашение заемных средств (BTC/USDT).
4. Логирование причины и состояния счёта.

## 9. Основные причины завершения цикла

- `target` — достигнута цель по net bps.
- `emergency_stop` — быстрый убыток превышает порог.
- `stop_loss` — превышен максимальный допустимый убыток.
- `data_stale` — устаревание данных во время сопровождения.
- `timeout` — победитель не найден в DETECTING.
- `cut_loser_failed` / `exit_winner_failed` — ошибки исполнения.
- `enter_exception` — исключение на входе.
