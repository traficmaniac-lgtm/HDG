# Алгоритм торговли: полный цикл

Ниже описан полный цикл directional hedge scalping, реализованный в `DirectionalCycle`.

## 1. Подготовка

- Бот переводится в состояние **ARMED**.
- Получает фильтры символа (step size, min qty, min notional, tick size).
- В реальном времени получает тики (`bid/ask/mid`, spread, источник данных).

## 2. Попытка входа (ENTRY)

Вход инициируется вручную или автолупом, но допускается только если:

- есть актуальный тик;
- загружены фильтры инструмента;
- нет открытой экспозиции и открытых ордеров;
- пройдены фильтры входа (spread, tick rate, импульс, свежесть данных).

### Действия на входе

1. Рассчитывается `qty = usd_notional / mid` и округляется по `step_size`.
2. Проверяются `min_qty` и `min_notional`.
3. Отправляются два ордера:
   - **SELL** (короткая нога) с `AUTO_BORROW`.
   - **BUY** (длинная нога).
4. Ордеры могут быть:
   - **market**, или
   - **aggressive limit** (IOC с ценой на 1 тик “за” текущим bid/ask).
5. Оба ордера должны быть заполнены, иначе выполняется аварийное выравнивание.

После успешного входа цикл переходит в **DETECTING**.

## 3. Поиск победителя (DETECTING)

- Окно обнаружения — `detect_window_ticks` тиков.
- Таймаут — `detect_timeout_ms`.
- Вычисляется движение цены в bps для LONG и SHORT от `entry_mid`.
- Если победителя нет (движение ниже `winner_threshold_bps`), выполняется выход без победителя.
- Победитель определяется по большему движению в bps.

После выявления победителя цикл переходит в **CUTTING**.

## 4. Отсечение проигравшего (CUTTING)

- Открытая убыточная нога закрывается рыночным или aggressive-limit ордером.
- Для шорта используется `AUTO_REPAY`.
- При ошибке или таймауте — аварийное выравнивание.

После закрытия проигравшего цикл переходит в **RIDING**.

## 5. Сопровождение победителя (RIDING)

В состоянии **RIDING** бот отслеживает:

- **Target**: `winner_net_bps >= target_net_bps` → выход по цели.
- **Emergency stop**: `winner_raw_bps <= -emergency_stop_bps` → срочный выход.
- **Data stale**: если свежесть данных хуже 1500 мс → выход.

## 6. Выход победителя (EXITING)

- Победитель закрывается рыночным или aggressive-limit ордером.
- Для шорта используется `AUTO_REPAY`.
- Фиксируется результат и формируется запись сделки.

После выхода:

- происходит погашение долгов (repay) по BTC/USDT,
- состояние меняется на **COOLDOWN**.

## 7. Охлаждение (COOLDOWN)

- Фиксированная пауза (`cooldown_s`) перед следующей попыткой.
- При авто-режиме цикл возвращается в **ARMED**.
- Вручную можно остановить или завершить cooldown.

## 8. Аварийное выравнивание (EMERGENCY FLATTEN)

Срабатывает если:

- частичный вход,
- ошибка при закрытии ноги,
- таймаут ожидания ордеров,
- ручной вызов.

Действия:

- отмена открытых ордеров;
- закрытие свободного BTC/шорт-позиции;
- погашение заемных средств (BTC/USDT).
