# Market Data

## WS vs HTTP fallback
- Основной источник: WS `bookTicker` (минимальная задержка).
- Резервный источник: HTTP `bookTicker` (устойчивость при сбоях WS).

## Метрики возраста
- `ws_age_ms` — возраст последнего WS-апдейта.
- `http_age_ms` — возраст последнего HTTP-апдейта.
- `mid_age_ms` — возраст последней рассчитанной mid-цены.

## Правила валидности цены
Котировка считается валидной, если:
- **WS**: `ws_age_ms <= ws_fresh_ms` и есть `bid/ask`.
- **HTTP**: `http_age_ms <= http_fresh_ms` и есть `bid/ask`.
- Если нет валидных источников, источник = `NONE`, а `mid` = `None`.

## Расчёт mid
- `mid = (bid + ask) / 2` и используется **исключительно** для TP/SL.
- При `mid = None` запрещены авто-выходы и блокируется размещение (NO_PRICE).

## Data blind режим
- `data_blind = True`, если нет свежего источника или нет `bid/ask`.
- В этом режиме `TradeExecutor` блокирует вход/выход, чтобы избежать торгов по stale данным.

## Использование в торговле
- Вход (BUY): требует валидный `bid`, иначе блокировка.
- Выход (SELL): для лимитного выхода нужен `ask`; для TP/SL нужен `mid`.
- При blackout (оба источника не свежие) авто-выходы замораживаются (`EXITS_FROZEN`).

## Причины HTTP fallback
- WS не подключён или потеря соединения.
- WS-данные устарели (`ws_age_ms > ws_fresh_ms`).
- WS-данные неполные (нет `bid/ask`).
