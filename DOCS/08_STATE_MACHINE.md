# State Machine

## Уровни состояния
### 1) Состояние подключения (GUI)
- **DISCONNECTED** → сервисы не запущены.
- **CONNECTED** → WS/HTTP/REST работают, торговля может быть запущена.

### 2) Торговое состояние (TradeExecutor)
- **IDLE**: цикл не активен, ордеров нет.
- **PLACE_BUY**: постановка BUY.
- **WAIT_BUY**: ожидание BUY и логика follow‑top.
- **POSITION_OPEN**: позиция открыта, мониторинг TP/SL.
- **PLACE_SELL**: постановка SELL.
- **WAIT_SELL**: ожидание SELL, TTL/повторы.
- **CLOSED**: завершение цикла, расчёт PnL.
- **ERROR**: восстановление после критической ошибки, затем возврат в IDLE.

## Разрешённые действия (TradeExecutor)
- **IDLE**: можно START, можно менять настройки.
- **WAIT_BUY**: только отмены/репрайсы BUY и ожидание исполнения.
- **POSITION_OPEN**: допускаются TP/SL и ручной CLOSE.
- **WAIT_SELL**: только ожидание/повторы/TTL.

## Основные переходы
- `IDLE → PLACE_BUY → WAIT_BUY`: START.
- `WAIT_BUY → POSITION_OPEN`: BUY исполнен (полностью или частично по таймауту).
- `POSITION_OPEN → PLACE_SELL → WAIT_SELL`: TP/SL или ручной CLOSE.
- `WAIT_SELL → CLOSED → IDLE`: SELL исполнен.
- `ANY → ERROR → IDLE`: ошибка REST/авторизации или критический сбой.

## Логика стопа
- **STOP** закрывает активный цикл:
  - отменяет ордера;
  - если позиция открыта и авто‑выход включён — выставляет SELL;
  - иначе возвращает в IDLE.

## Контроль прогресса цикла
- `cycles_target` определяет число циклов (0 = бесконечно).
- После каждого цикла выставляется задержка `cycle_cooldown_s`.
- После ошибок используется `recovery_cooldown_s`.
- При превышении `max_consecutive_failures` сессия останавливается.
