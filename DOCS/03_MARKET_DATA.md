# Market Data

## Источники
- **WS**: `wss://stream.binance.com/...@bookTicker` (реальное время).
- **HTTP**: `GET /api/v3/ticker/bookTicker` (резерв).

## Маршрутизация и стабилизация (PriceRouter)
1. **Свежесть**:
   - `ws_age_ms` — возраст последнего WS‑тика.
   - `http_age_ms` — возраст последнего HTTP‑тика.
   - `mid_age_ms` — возраст текущей стабильной mid‑цены.
2. **WS‑стабильность**:
   - WS считается стабильным при серии свежих тиков (≥3) или по истечении `ws_switch_hysteresis_ms`.
3. **Выбор источника**:
   - Приоритет **WS**, если он стабильный и свежий.
   - При потере WS — fallback на **HTTP** при свежих данных.
   - Если оба источника устарели → `source = NONE`.
4. **Кеш последней хорошей котировки**:
   - При отсутствии свежих данных сохраняется последняя `mid` до `good_quote_ttl_ms`.
   - По истечении TTL выставляется `data_blind=True` и `ttl_expired=True`.

## Правила `mid`
- `mid = (bid + ask) / 2`, затем округление до `tick_size`.
- Если `mid` отсутствует → `data_blind=True` и может использоваться кеш (до TTL).

## Использование данных в торговле
### Вход (BUY)
- При деградации WS (нет соединения/«no first tick»/«stale ticks») вход переключается на HTTP‑снапшот.
- В обычном режиме вход использует `mid`/`bid` только если данные свежее `mid_fresh_ms`.
- При отсутствии валидной цены вход «замораживается» и может быть прерван по таймауту ожидания цены.

### Выход (TP/SL)
- TP/SL рассчитываются по `mid`.
- Если нет свежих данных по `mid_fresh_ms`, выход **замораживается** (`EXITS_FROZEN`) до появления свежих котировок.

## Диагностика данных
- `last_switch_reason`: причина смены источника (`ws_stable`, `ws_stale`, `no_fresh_data`).
- Логи источника и задержек помогают объяснить блокировку входа/выхода.
