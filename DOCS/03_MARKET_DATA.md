# 03_MARKET_DATA — Рыночные данные и здоровье данных

## Как получаем цену
1. **WS bookTicker** (основной источник)
   - Поток bid/ask в реальном времени.
   - Считается быстрым и приоритетным.
2. **HTTP bookTicker** (fallback)
   - Периодический опрос при проблемах WS или по правилам data-health.
3. **PriceRouter**
   - Выдаёт стабильный mid, bid, ask и источник (WS/HTTP/NONE).

## WS проблемы на EURIUSDT
- Практически важная проблема: **WS может «замерзать»** (нет тиков или тики приходят слишком редко).
- Реакция:
  - если нет тика > 3 секунд — считается сбой первого тика;
  - если нет тиков > 2 секунд — поток объявляется «stale»;
  - при сбоях выполняется переподключение.

## HTTP fallback (как ДОЛЖНО работать)
- HTTP используется, когда:
  - WS «stale» (данные устарели),
  - WS ещё не стабилизировался (не набрана серия свежих тиков),
  - включён режим защиты позиции (position_guard_http).
- Цель: **всегда иметь валидную котировку** для контроля позиции и выхода.

## tick-cache / last_good_quote
- PriceRouter хранит **последнюю валидную котировку**:
  - `last_good_bid`, `last_good_ask`, `last_good_mid`, `last_good_ts`.
- Если свежих данных нет, но TTL не истёк — используется кэш (from_cache).
- Если TTL истёк — `ttl_expired=True`, торговля блокируется.

## Правила data-health (когда можно торговать)
**Можно торговать только если:**
- `price_state.data_blind == False` (есть свежая цена),
- `mid != None`,
- источник `WS` или `HTTP` со свежестью в пределах `ws_stale_ms` / `http_fresh_ms`.

**Запрещено торговать если:**
- `data_blind == True` и кэш истёк (`ttl_expired=True`),
- mid отсутствует,
- возраст mid превышает допустимый TTL.

**Важно:**
- Даже если используется кэш (from_cache), торговля должна быть ограничена: разрешены только безопасные действия (например, аварийное закрытие), но не новый вход.
